-- Add template-specific fields to projects table
ALTER TABLE public.projects
ADD COLUMN IF NOT EXISTS template_description TEXT,
ADD COLUMN IF NOT EXISTS template_niche VARCHAR(50),
ADD COLUMN IF NOT EXISTS template_version INTEGER DEFAULT 1,
ADD COLUMN IF NOT EXISTS template_preview_image TEXT;

-- Create enum for template niches if it doesn't exist
DO $$ 
BEGIN
    IF NOT EXISTS (SELECT 1 FROM pg_type WHERE typname = 'template_niche_enum') THEN
        CREATE TYPE template_niche_enum AS ENUM (
            'veterinarian',
            'chiropractor',
            'dentist',
            'medical',
            'legal',
            'restaurant',
            'retail',
            'general'
        );
    END IF;
END $$;

-- Update the template_niche column to use the enum (if we want strict validation)
-- For now, keeping it as VARCHAR for flexibility

-- Add index for template queries
CREATE INDEX IF NOT EXISTS idx_projects_template_status 
ON public.projects(project_status) 
WHERE project_status IN ('template-internal', 'template-public');

-- Add index for niche filtering
CREATE INDEX IF NOT EXISTS idx_projects_template_niche 
ON public.projects(template_niche) 
WHERE project_status IN ('template-internal', 'template-public');

-- Update project_management_view to include template fields
CREATE OR REPLACE VIEW project_management_view AS
SELECT 
    p.id,
    p.project_name,
    p.project_type,
    p.project_status,
    p.domain,
    p.subdomain,
    p.deployment_status,
    p.deployment_url,
    p.last_deployed_at,
    p.created_at,
    p.updated_at,
    p.customer_id,
    p.template_description,
    p.template_niche,
    p.template_version,
    p.template_preview_image,
    c.business_name,
    c.account_type,
    c.contact_email,
    -- Categorize projects into tabs based on status
    CASE 
        WHEN p.project_status = 'draft' THEN 'draft'
        WHEN p.project_status IN ('template-internal', 'template-public') THEN 'templates'
        WHEN p.project_status IN ('prospect-staging', 'live-customer') THEN 'active'
        WHEN p.project_status = 'paused-maintenance' THEN 'paused'
        WHEN p.project_status = 'archived' THEN 'archive'
        ELSE 'draft'
    END AS tab_category
FROM projects p
LEFT JOIN customers c ON p.customer_id = c.id;

-- Grant permissions
GRANT SELECT ON project_management_view TO authenticated;

-- Add RLS policies for template fields (inherits existing project policies)
-- No additional policies needed as they use the existing project RLS

-- Add comment for documentation
COMMENT ON COLUMN public.projects.template_description IS 'Description of the template for display in template library';
COMMENT ON COLUMN public.projects.template_niche IS 'Business niche/category this template is designed for';
COMMENT ON COLUMN public.projects.template_version IS 'Version number for template tracking';
COMMENT ON COLUMN public.projects.template_preview_image IS 'URL to preview image for template library display';